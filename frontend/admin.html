<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <title>Panel de Administración</title>
  <!-- Bootstrap 5 CSS -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
  <!-- Bootstrap Icons -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css" rel="stylesheet">
  <style>
    :root {
      --bg-gradient-start: #eef2ff;
      --bg-gradient-end: #f8fbff;
      --primary-600: #1d4ed8;
      --primary-500: #2563eb;
      --primary-100: #dbeafe;
      --neutral-900: #111827;
      --neutral-600: #4b5563;
      --neutral-200: #e5e7eb;
      --success-500: #16a34a;
    }

    body {
      min-height: 100vh;
      background: radial-gradient(circle at top right, var(--bg-gradient-start), var(--bg-gradient-end));
      font-family: "Inter", "Segoe UI", system-ui, -apple-system, sans-serif;
      color: var(--neutral-900);
    }

    .admin-header {
      background: linear-gradient(135deg, var(--primary-600), var(--primary-500));
      border-radius: 24px;
      padding: 2rem 2.5rem;
      box-shadow: 0 20px 45px -20px rgba(29, 78, 216, 0.55);
      color: #fff;
    }

    .admin-header h1 {
      font-weight: 600;
      letter-spacing: 0.02em;
    }

    .admin-header p {
      margin-bottom: 0;
      opacity: 0.85;
    }

    .logout-link {
      background-color: rgba(255, 255, 255, 0.15);
      color: #fff;
      border: none;
      transition: background-color 0.2s ease, transform 0.2s ease;
    }

    .logout-link:hover,
    .logout-link:focus {
      background-color: rgba(255, 255, 255, 0.28);
      color: #fff;
      transform: translateY(-1px);
    }

    .section-title {
      font-size: 1.05rem;
      font-weight: 600;
      color: var(--neutral-600);
      text-transform: uppercase;
      letter-spacing: 0.06em;
      margin-bottom: 0.75rem;
    }

    .card-elevated {
      background: #fff;
      border: none;
      border-radius: 18px;
      box-shadow: 0 20px 50px -24px rgba(15, 23, 42, 0.35);
      padding: 1.75rem;
      margin-bottom: 2rem;
    }

    .card-elevated + .card-elevated {
      margin-top: -0.5rem;
    }

    .card-elevated .card-header {
      background: transparent;
      border: none;
      padding: 0;
      margin-bottom: 1.5rem;
    }

    .table-responsive {
      border-radius: 16px;
      border: 1px solid rgba(37, 99, 235, 0.08);
      box-shadow: inset 0 1px 0 rgba(255, 255, 255, 0.6);
    }

    table {
      margin-bottom: 0;
      overflow: hidden;
    }

    thead tr {
      background: linear-gradient(90deg, rgba(37, 99, 235, 0.12), rgba(37, 99, 235, 0.04));
    }

    th {
      text-transform: uppercase;
      font-size: 0.72rem;
      letter-spacing: 0.08em;
      color: var(--neutral-600);
      border-bottom: none !important;
      background-color: transparent !important;
    }

    td {
      vertical-align: middle !important;
      border-color: rgba(15, 23, 42, 0.05) !important;
    }

    tbody tr:hover {
      background-color: rgba(219, 234, 254, 0.35) !important;
    }

    .badge.bg-success {
      background: var(--success-500) !important;
      font-weight: 600;
      letter-spacing: 0.02em;
    }

    .table-controls {
      background: #fff;
      border-radius: 18px;
      box-shadow: 0 16px 40px -28px rgba(15, 23, 42, 0.45);
      padding: 0.9rem 1.4rem;
      border: 1px solid rgba(37, 99, 235, 0.08);
    }

    .table-controls .form-range {
      min-width: 160px;
    }

    .table-controls .pagination {
      margin-bottom: 0;
    }

    .btn {
      border-radius: 999px;
      font-weight: 500;
      letter-spacing: 0.01em;
    }

    .btn.btn-primary {
      background: var(--primary-500);
      border-color: var(--primary-500);
      box-shadow: 0 10px 30px -15px rgba(37, 99, 235, 0.65);
    }

    .btn.btn-primary:hover {
      background: #1e40af;
      border-color: #1e40af;
    }

    .btn.btn-success {
      background: var(--success-500);
      border-color: var(--success-500);
      box-shadow: 0 10px 30px -15px rgba(22, 163, 74, 0.6);
    }

    .btn.btn-success:hover {
      background: #15803d;
      border-color: #15803d;
    }

    .form-control,
    .form-select {
      border-radius: 12px;
      border-color: rgba(148, 163, 184, 0.4);
      box-shadow: inset 0 1px 2px rgba(15, 23, 42, 0.08);
    }

    .form-control:focus,
    .form-select:focus {
      border-color: var(--primary-500);
      box-shadow: 0 0 0 0.25rem rgba(37, 99, 235, 0.18);
    }

    .filters-card {
      background: rgba(255, 255, 255, 0.86);
      border-radius: 18px;
      border: 1px solid rgba(37, 99, 235, 0.08);
      box-shadow: 0 16px 40px -30px rgba(15, 23, 42, 0.55);
      padding: 1.5rem;
      margin-bottom: 1.8rem;
    }

    .filters-card .form-floating > label {
      color: var(--neutral-600);
      font-weight: 500;
    }

    .filters-card .btn {
      border-radius: 12px;
    }

    .new-row td {
      background: rgba(219, 234, 254, 0.35);
      font-weight: 500;
    }

    .save-btn,
    .delete-btn {
      transition: transform 0.2s ease;
    }

    .save-btn:hover,
    .delete-btn:hover,
    .edit-cita-btn:hover,
    .edit-mecanico-btn:hover {
      transform: translateY(-1px);
    }

    .confirmation-modal {
      border: none;
      border-radius: 24px;
      box-shadow: 0 28px 60px -20px rgba(29, 78, 216, 0.45);
      overflow: hidden;
    }

    .confirmation-modal .modal-header {
      background: linear-gradient(135deg, rgba(37, 99, 235, 0.12), rgba(37, 99, 235, 0.04));
      border-bottom: none;
      padding: 1.5rem 1.75rem 1rem;
    }

    .confirmation-modal .icon-circle {
      height: 44px;
      width: 44px;
      border-radius: 50%;
      display: inline-flex;
      align-items: center;
      justify-content: center;
      background: rgba(37, 99, 235, 0.12);
      color: var(--primary-500);
      font-size: 1.25rem;
    }

    .confirmation-modal .modal-body {
      padding: 0 1.75rem 1.5rem;
      color: var(--neutral-600);
      font-size: 0.98rem;
    }

    .confirmation-modal .modal-footer {
      border-top: none;
      padding: 0 1.75rem 1.75rem;
    }

    @media (max-width: 992px) {
      .admin-header {
        padding: 1.75rem;
      }

      .card-elevated {
        padding: 1.5rem;
      }
    }

    @media (max-width: 600px) {
      .admin-header {
        border-radius: 18px;
      }

      .admin-header h1 {
        font-size: 1.5rem;
      }

      th,
      td {
        font-size: 0.92rem;
        padding: 0.65rem;
      }

      .btn {
        font-size: 0.9rem;
        padding: 0.4rem 0.9rem;
      }

      .filters-card {
        padding: 1.25rem;
      }

      .table-controls {
        padding: 0.85rem 1rem;
      }
    }
  </style>
</head>
<body>
  <div class="container py-5">
    <div class="admin-header mb-5">
      <div class="d-flex flex-column flex-md-row align-items-md-center justify-content-between gap-3">
        <div>
          <h1 class="display-6 mb-2">Panel de Administración</h1>
          <p class="mb-0">Gestiona usuarios, citas y mecánicos con una vista profesional.</p>
        </div>
        <div>
          <a href="/logout" class="btn logout-link px-4 py-2">
            <i class="bi bi-box-arrow-right me-2"></i> Cerrar sesión
          </a>
        </div>
      </div>
    </div>

    <!-- === Usuarios (solo lectura) === -->
    <section class="card-elevated">
      <div class="card-header d-flex justify-content-between align-items-center">
        <div>
          <span class="section-title">Usuarios registrados</span>
          <h2 class="h4 mb-0">Directorio de usuarios</h2>
        </div>
      </div>
      <div class="table-responsive">
        <table id="usuarios-table" class="table table-bordered table-hover align-middle mb-0">
          <thead class="table-light">
            <tr>
              <th>ID</th>
              <th>Teléfono</th>
              <th>Nueva contraseña</th>
              <th>¿Administrador?</th>
              <th>Acciones</th>
            </tr>
          </thead>
          <tbody>
            {% for u in usuarios %}
            <tr data-id="{{ u.id_usuario }}">
              <td>{{ u.id_usuario }}</td>
              <td>
                <input type="tel" name="telefono" value="{{ u.telefono }}" class="form-control form-control-sm" disabled>
              </td>
              <td>
                <input type="password" name="contrasena" placeholder="Dejar en blanco para mantener" class="form-control form-control-sm" disabled>
              </td>
              <td>
                <select name="es_admin" class="form-select form-select-sm" disabled>
                  <option value="1" {% if u.es_admin %}selected{% endif %}>Sí</option>
                  <option value="0" {% if not u.es_admin %}selected{% endif %}>No</option>
                </select>
              </td>
              <td>
                <button class="edit-usuario-btn btn btn-sm btn-primary" title="Editar">
                  <i class="bi bi-pencil"></i>
                </button>
                <button class="save-usuario-btn save-btn btn btn-sm btn-success" style="display:none;" title="Guardar">
                  <i class="bi bi-check-lg"></i>
                </button>
                <button class="delete-usuario-btn delete-btn btn btn-sm btn-danger" title="Eliminar">
                  <i class="bi bi-trash"></i>
                </button>
              </td>
            </tr>
            {% endfor %}
          </tbody>
        </table>
      </div>
      <div class="mt-4">
        <div class="bg-light border rounded-4 p-4">
          <h3 class="h6 text-uppercase text-primary fw-semibold mb-3">Agregar nuevo usuario</h3>
          <form id="add-usuario-form" class="row g-3 align-items-end">
            <div class="col-12 col-md-4">
              <label for="nuevo-telefono" class="form-label">Teléfono</label>
              <input type="tel" class="form-control" id="nuevo-telefono" name="telefono" placeholder="Ej. 71234567" required minlength="8" maxlength="8" pattern="[0-9]{8}">
            </div>
            <div class="col-12 col-md-4">
              <label for="nuevo-password" class="form-label">Contraseña</label>
              <input type="password" class="form-control" id="nuevo-password" name="contrasena" placeholder="Mínimo 6 caracteres" required minlength="6">
            </div>
            <div class="col-12 col-md-4">
              <div class="d-flex align-items-center gap-3">
                <div class="form-check">
                  <input class="form-check-input" type="checkbox" value="1" id="nuevo-es-admin" name="es_admin">
                  <label class="form-check-label" for="nuevo-es-admin">
                    Con privilegios de administrador
                  </label>
                </div>
                <button type="submit" class="btn btn-success">
                  <i class="bi bi-person-plus"></i> Crear usuario
                </button>
              </div>
            </div>
          </form>
        </div>
      </div>
    </section>

    <!-- === Citas (edición rápida) === -->
    <section class="card-elevated">
      <div class="card-header d-flex justify-content-between align-items-center flex-wrap gap-2">
        <div>
          <span class="section-title">Gestión de citas</span>
          <h2 class="h4 mb-0">Agenda de servicios</h2>
        </div>
      </div>
      <!-- Filtros -->
      <div id="citas-filtros" class="filters-card row g-3 align-items-end">
        <div class="col">
          <div class="form-floating">
            <input type="date" id="filtrar-desde" class="form-control" placeholder="Desde">
            <label for="filtrar-desde">Desde</label>
          </div>
        </div>
        <div class="col">
          <div class="form-floating">
            <input type="date" id="filtrar-hasta" class="form-control" placeholder="Hasta">
            <label for="filtrar-hasta">Hasta</label>
          </div>
        </div>
        <div class="col">
          <div class="form-floating">
            <select id="filtrar-estado" class="form-select" aria-label="Estado">
              <option value="" selected>Todos</option>
              <option value="confirmada">confirmada</option>
              <option value="reprogramada">reprogramada</option>
              <option value="en progreso">en progreso</option>
              <option value="cancelada">cancelada</option>
              <option value="completada">completada</option>
            </select>
            <label for="filtrar-estado">Estado</label>
          </div>
        </div>
        <div class="col">
          <div class="form-floating">
            <select id="filtrar-mecanico" class="form-select" aria-label="Mecánico">
              <option value="" selected>Todos</option>
              {% for m in mecanicos %}
              <option value="{{ m.id_mecanico }}">{{ m.nombre }}</option>
              {% endfor %}
            </select>
            <label for="filtrar-mecanico">Mecánico</label>
          </div>
        </div>
        <div class="col">
          <div class="form-floating">
            <input type="text" id="filtrar-servicio" class="form-control" placeholder="Servicio">
            <label for="filtrar-servicio">Servicio</label>
          </div>
        </div>
        <div class="col">
          <div class="form-floating">
            <input type="text" id="filtrar-busqueda" class="form-control" placeholder="Usuario o teléfono">
            <label for="filtrar-busqueda">Usuario o teléfono</label>
          </div>
        </div>
        <div class="col-12 col-md-auto">
          <button id="buscar-filtros" type="button" class="btn btn-primary w-100">
            <i class="bi bi-search"></i> Buscar
          </button>
        </div>
        <div class="col-12 col-md-auto">
          <button id="limpiar-filtros" type="button" class="btn btn-outline-secondary w-100">Limpiar filtros</button>
        </div>
      </div>
      <div class="table-responsive mb-4">
        <table id="citas-table" class="table table-bordered table-hover align-middle mb-0">
          <thead class="table-light">
            <tr>
              <th>ID</th>
              <th>Usuario</th>
              <th>Teléfono</th>
              <th>Servicio</th>
              <th>Fecha</th>
              <th>Hora</th>
              <th>Mecánico</th>
              <th>Estado</th>
              <th>Acción</th>
            </tr>
          </thead>
          <tbody>
            {% for c in citas %}
            <tr data-id="{{ c.id_citas }}">
              <td>{{ c.id_citas }}</td>
              <td>{{ c.id_usuario }}</td>
              <td>{{ c.telefono }}</td>
              <td><input type="text" name="servicio" value="{{ c.servicio }}" class="form-control form-control-sm" disabled></td>
              <td><input type="date" name="fecha" value="{{ c.fecha }}" class="form-control form-control-sm" disabled></td>
              <td><input type="time" name="hora" value="{{ c.hora }}" class="form-control form-control-sm" disabled></td>
              <td>
                <select name="id_mecanico" class="form-select form-select-sm" disabled>
                  <option value="">Sin asignar</option>
                  {% for m in mecanicos %}
                  <option value="{{ m.id_mecanico }}" {% if c.id_mecanico == m.id_mecanico %}selected{% endif %}>{{ m.nombre }}</option>
                  {% endfor %}
                </select>
              </td>
              <td>
                <select name="estado" class="form-select form-select-sm" disabled>
                  <option value="confirmada" {% if c.estado=='confirmada' %}selected{% endif %}>confirmada</option>
                  <option value="reprogramada" {% if c.estado=='reprogramada' %}selected{% endif %}>reprogramada</option>
                  <option value="en progreso" {% if c.estado=='en progreso' %}selected{% endif %}>en progreso</option>
                  <option value="cancelada" {% if c.estado=='cancelada' %}selected{% endif %}>cancelada</option>
                  <option value="completada" {% if c.estado=='completada' %}selected{% endif %}>completada</option>
                </select>
              </td>
              <td>
                <button class="edit-cita-btn btn btn-sm btn-primary" title="Editar">
                  <i class="bi bi-pencil"></i>
                </button>
                <button class="save-cita-btn save-btn btn btn-sm btn-success" style="display:none;" title="Guardar">
                  <i class="bi bi-check-lg"></i>
                </button>
                <button class="delete-cita-btn delete-btn btn btn-sm btn-danger" title="Eliminar">
                  <i class="bi bi-trash"></i>
                </button>
              </td>
            </tr>
            {% endfor %}
            <tr class="new-row">
              <td class="text-secondary">Nuevo</td>
              <td>
                <select id="new-usuario" class="form-select form-select-sm">
                  <option value="" selected disabled>Seleccione teléfono</option>
                  {% for u in usuarios %}
                  <option value="{{ u.id_usuario }}">{{ u.telefono }}</option>
                  {% endfor %}
                </select>
              </td>
              <td></td>
              <td><input type="text" id="new-servicio" placeholder="Servicio" class="form-control form-control-sm"></td>
              <td><input type="date" id="new-fecha" class="form-control form-control-sm"></td>
              <td><input type="time" id="new-hora" class="form-control form-control-sm"></td>
              <td>
                <select id="new-mecanico" class="form-select form-select-sm">
                  <option value="" selected>Sin asignar</option>
                  {% for m in mecanicos %}
                  <option value="{{ m.id_mecanico }}">{{ m.nombre }}</option>
                  {% endfor %}
                </select>
              </td>
              <td>
                <select id="new-estado" class="form-select form-select-sm">
                  <option value="confirmada">confirmada</option>
                  <option value="reprogramada">reprogramada</option>
                  <option value="en progreso">en progreso</option>
                  <option value="cancelada">cancelada</option>
                  <option value="completada">completada</option>
                </select>
              </td>
              <td>
                <button id="add-cita-btn" class="btn btn-sm btn-success">
                  <i class="bi bi-plus-lg"></i> Agregar
                </button>
              </td>
            </tr>
          </tbody>
        </table>
      </div>
    </section>

    <!-- === Mecánicos (CRUD) === -->
    <section class="card-elevated">
      <div class="card-header d-flex justify-content-between align-items-center">
        <div>
          <span class="section-title">Gestión de mecánicos</span>
          <h2 class="h4 mb-0">Equipo técnico</h2>
        </div>
      </div>
      <div class="table-responsive mb-4">
        <table id="mecanicos-table" class="table table-bordered table-hover align-middle mb-0">
          <thead class="table-light">
            <tr>
              <th>ID</th>
              <th>Nombre</th>
              <th>Teléfono</th>
              <th>Acciones</th>
            </tr>
          </thead>
          <tbody>
            {% for m in mecanicos %}
            <tr data-id="{{ m.id_mecanico }}">
              <td>{{ m.id_mecanico }}</td>
              <td><input type="text" name="nombre" value="{{ m.nombre }}" class="form-control form-control-sm" disabled></td>
              <td><input type="tel" name="telefono" value="{{ m.telefono }}" class="form-control form-control-sm" disabled></td>
              <td>
                <button class="edit-mecanico-btn btn btn-sm btn-primary" title="Editar">
                  <i class="bi bi-pencil"></i>
                </button>
                <button class="save-mecanico-btn save-btn btn btn-sm btn-success" style="display:none;" title="Guardar">
                  <i class="bi bi-check-lg"></i>
                </button>
                <button class="delete-mecanico-btn delete-btn btn btn-sm btn-danger" title="Eliminar">
                  <i class="bi bi-trash"></i>
                </button>
              </td>
            </tr>
            {% endfor %}
            <tr class="new-row">
              <td class="text-secondary">Nuevo</td>
              <td><input type="text" id="new-nombre" placeholder="Nombre" class="form-control form-control-sm"></td>
              <td><input type="tel" id="new-telefono" placeholder="Teléfono" class="form-control form-control-sm"></td>
              <td>
                <button id="add-mecanico-btn" class="btn btn-sm btn-success">
                  <i class="bi bi-plus-lg"></i> Agregar
                </button>
              </td>
            </tr>
          </tbody>
        </table>
      </div>
    </section>
  </div>

  <div class="modal fade" id="confirmationModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
      <div class="modal-content confirmation-modal">
        <div class="modal-header">
          <div class="d-flex align-items-center gap-3">
            <span class="icon-circle">
              <i class="bi bi-question-lg"></i>
            </span>
            <div>
              <h5 class="modal-title mb-1" id="confirmationModalTitle">Confirmar acción</h5>
              <p class="mb-0 small text-muted">Revisa la información antes de continuar.</p>
            </div>
          </div>
          <button type="button" class="btn-close"  aria-label="Cerrar"></button>
        </div>
        <div class="modal-body">
          <p class="mb-0" id="confirmationModalMessage"></p>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-outline-secondary" data-bs-dismiss="modal">Cancelar</button>
          <button type="button" class="btn btn-primary" id="confirmationModalConfirmBtn">Confirmar</button>
        </div>
      </div>
    </div>
  </div>

  <!-- Bootstrap JS Bundle -->
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
  <!-- Tu JavaScript CRUD, sin cambios -->
  <script>
    const confirmationModalElement = document.getElementById('confirmationModal');
    const confirmationModalMessage = document.getElementById('confirmationModalMessage');
    const confirmationModalConfirmBtn = document.getElementById('confirmationModalConfirmBtn');
    const confirmationModalCancelBtn = confirmationModalElement?.querySelector('[data-bs-dismiss="modal"]');

    function showConfirmation(message, { confirmText = 'Confirmar', cancelText = 'Cancelar' } = {}) {
      if (!confirmationModalElement || !window.bootstrap) {
        return Promise.resolve(window.confirm(message));
      }

      confirmationModalMessage.textContent = message;
      confirmationModalConfirmBtn.textContent = confirmText;
      if (confirmationModalCancelBtn) {
        confirmationModalCancelBtn.textContent = cancelText;
      }

      return new Promise(resolve => {
        const modalInstance = bootstrap.Modal.getOrCreateInstance(confirmationModalElement);

        const cleanup = () => {
          confirmationModalConfirmBtn.removeEventListener('click', handleConfirm);
          confirmationModalElement.removeEventListener('hidden.bs.modal', handleHidden);
        };

        const handleConfirm = () => {
          cleanup();
          resolve(true);
          modalInstance.hide();
        };

        const handleHidden = () => {
          cleanup();
          resolve(false);
        };

        confirmationModalConfirmBtn.addEventListener('click', handleConfirm, { once: true });
        confirmationModalElement.addEventListener('hidden.bs.modal', handleHidden, { once: true });
        modalInstance.show();
      });
    }

    class TablePaginator {
      constructor(table, options = {}) {
        this.table = table;
        this.rowsPerPage = options.rowsPerPage || 7;
        this.excludeSelector = options.excludeSelector || '';
        this.currentPage = 1;
        this.container = document.createElement('div');
        this.container.className = 'table-controls d-flex flex-column flex-md-row align-items-start align-items-md-center justify-content-between gap-3 mt-2';
        this.info = document.createElement('div');
        this.info.className = 'small text-secondary';
        this.rangeWrapper = document.createElement('div');
        this.rangeWrapper.className = 'd-flex align-items-center gap-2 flex-grow-1 w-100';
        this.rangeLabel = document.createElement('span');
        this.rangeLabel.className = 'small text-secondary text-nowrap';
        this.slider = document.createElement('input');
        this.slider.type = 'range';
        this.slider.className = 'form-range flex-grow-1';
        this.slider.min = 1;
        this.slider.max = 1;
        this.slider.value = 1;
        this.slider.addEventListener('input', () => {
          this.currentPage = Number(this.slider.value);
          this.refresh();
        });
        this.rangeWrapper.append(this.rangeLabel, this.slider);
        this.nav = document.createElement('nav');
        this.nav.setAttribute('aria-label', 'Paginación de tabla');
        this.container.append(this.info, this.rangeWrapper, this.nav);
        this.table.parentElement.insertAdjacentElement('afterend', this.container);
        this.refresh();
      }

      get dataRows() {
        const selector = this.excludeSelector ? `tbody tr:not(${this.excludeSelector})` : 'tbody tr';
        return Array.from(this.table.querySelectorAll(selector));
      }

      get filteredRows() {
        return this.dataRows.filter(row => row.dataset.filteredOut !== 'true');
      }

      goToPage(page) {
        this.currentPage = Math.max(1, Number(page) || 1);
        this.refresh();
      }

      refresh() {
        const rows = this.dataRows;
        const visibleRows = this.filteredRows;
        const totalPages = Math.max(1, Math.ceil(visibleRows.length / this.rowsPerPage));
        this.currentPage = Math.min(this.currentPage, totalPages);
        const start = (this.currentPage - 1) * this.rowsPerPage;
        const end = start + this.rowsPerPage;

        rows.forEach(row => {
          if (row.dataset.filteredOut === 'true') {
            row.style.display = 'none';
          }
        });

        visibleRows.forEach((row, index) => {
          row.style.display = (index >= start && index < end) ? '' : 'none';
        });

        if (this.excludeSelector) {
          this.table.querySelectorAll(`tbody tr${this.excludeSelector}`).forEach(row => {
            row.style.display = '';
          });
        }

        const totalVisible = visibleRows.length;
        const from = totalVisible ? start + 1 : 0;
        const to = totalVisible ? Math.min(end, totalVisible) : 0;
        this.info.textContent = totalVisible ? `Mostrando ${from}-${to} de ${totalVisible}` : 'Sin registros';

        this.slider.max = totalPages;
        this.slider.value = this.currentPage;
        this.slider.disabled = totalPages <= 1;
        this.rangeLabel.textContent = `Página ${this.currentPage} de ${totalPages}`;

        this.renderPagination(totalPages);
      }

      renderPagination(totalPages) {
        this.nav.innerHTML = '';
        if (totalPages <= 1) {
          this.nav.style.display = 'none';
          return;
        }

        this.nav.style.display = '';
        const ul = document.createElement('ul');
        ul.className = 'pagination pagination-sm mb-0';

        const createItem = (label, page, disabled = false, active = false) => {
          const li = document.createElement('li');
          li.className = 'page-item';
          if (disabled) li.classList.add('disabled');
          if (active) li.classList.add('active');
          const button = document.createElement('button');
          button.type = 'button';
          button.className = 'page-link';
          button.textContent = label;
          if (!disabled) {
            button.addEventListener('click', () => {
              this.currentPage = page;
              this.refresh();
            });
          }
          li.appendChild(button);
          return li;
        };

        ul.appendChild(createItem('«', Math.max(1, this.currentPage - 1), this.currentPage === 1));
        for (let page = 1; page <= totalPages; page++) {
          ul.appendChild(createItem(page, page, false, page === this.currentPage));
        }
        ul.appendChild(createItem('»', Math.min(totalPages, this.currentPage + 1), this.currentPage === totalPages));

        this.nav.appendChild(ul);
      }
    }

    const usuariosPaginator = new TablePaginator(document.getElementById('usuarios-table'), { rowsPerPage: 7 });
    const citasPaginator = new TablePaginator(document.getElementById('citas-table'), { rowsPerPage: 7, excludeSelector: '.new-row' });
    const mecanicosPaginator = new TablePaginator(document.getElementById('mecanicos-table'), { rowsPerPage: 7, excludeSelector: '.new-row' });

    // — CRUD Usuarios —
    document.querySelectorAll('.edit-usuario-btn').forEach(btn => {
      btn.addEventListener('click', () => {
        const tr = btn.closest('tr');
        tr.querySelectorAll('input, select').forEach(el => el.disabled = false);
        btn.style.display = 'none';
        tr.querySelector('.save-usuario-btn').style.display = 'inline-block';
      });
    });

    document.querySelectorAll('.save-usuario-btn').forEach(btn => {
      btn.addEventListener('click', async () => {
        const tr = btn.closest('tr');
        const id = tr.dataset.id;
        const telefono = tr.querySelector('input[name="telefono"]').value.trim();
        const contrasena = tr.querySelector('input[name="contrasena"]').value.trim();
        const esAdmin = tr.querySelector('select[name="es_admin"]').value;

        if (!await showConfirmation('¿Desea confirmar los cambios de este usuario?')) {
          return;
        }

        const params = new URLSearchParams();
        params.append('telefono', telefono);
        params.append('es_admin', esAdmin);
        if (contrasena) {
          params.append('contrasena', contrasena);
        }

        const res = await fetch(`/admin/actualizar_usuario/${id}`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
          body: params.toString()
        });

        if (res.ok) {
          tr.querySelectorAll('input, select').forEach(el => el.disabled = true);
          tr.querySelector('input[name="contrasena"]').value = '';
          btn.style.display = 'none';
          tr.querySelector('.edit-usuario-btn').style.display = 'inline-block';
        } else {
          let mensaje = 'Error al actualizar el usuario';
          try {
            const data = await res.json();
            if (data.error) mensaje = data.error;
          } catch (_) {}
          alert(mensaje);
        }
      });
    });

    document.querySelectorAll('.delete-usuario-btn').forEach(btn => {
      btn.addEventListener('click', async () => {
        const tr = btn.closest('tr');
        const id = tr.dataset.id;
        const confirmado = await showConfirmation('¿Eliminar este usuario?', { confirmText: 'Sí, eliminar' });
        if (!confirmado) return;
        const res = await fetch(`/admin/eliminar_usuario/${id}`, { method: 'POST' });
        if (res.ok) {
          location.reload();
        } else {
          let mensaje = 'Error al eliminar el usuario';
          try {
            const data = await res.json();
            if (data.error) mensaje = data.error;
          } catch (_) {}
          alert(mensaje);
        }
      });
    });

    // — CRUD Citas —
    document.querySelectorAll('.edit-cita-btn').forEach(btn => {
      btn.addEventListener('click', () => {
        const tr = btn.closest('tr');
        tr.querySelectorAll('input, select').forEach(i => i.disabled = false);
        btn.style.display = 'none';
        tr.querySelector('.save-cita-btn').style.display = 'inline-block';
      });
    });

    document.querySelectorAll('.save-cita-btn').forEach(btn => {
      btn.addEventListener('click', async () => {
        const tr = btn.closest('tr');
        const id = tr.dataset.id;
        const servicio = tr.querySelector('input[name="servicio"]').value;
        const fecha = tr.querySelector('input[name="fecha"]').value;
        const hora   = tr.querySelector('input[name="hora"]').value;
        const mecanico = tr.querySelector('select[name="id_mecanico"]').value;
        const estado = tr.querySelector('select[name="estado"]').value;

        if (!await showConfirmation('¿Desea confirmar los cambios de esta cita?')) {
          return;
        }

        const params = new URLSearchParams({ servicio, fecha, hora, estado, id_mecanico: mecanico });
        const res = await fetch(`/admin/actualizar_cita/${id}`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
          body: params.toString()
        });
        if (res.ok) {
          tr.querySelectorAll('input, select').forEach(i => i.disabled = true);
          btn.style.display = 'none';
          tr.querySelector('.edit-cita-btn').style.display = 'inline-block';
        } else {
          alert('Error al actualizar la cita');
        }
      });
    });

    document.querySelectorAll('.delete-cita-btn').forEach(btn => {
      btn.addEventListener('click', async () => {
        const tr = btn.closest('tr');
        const id = tr.dataset.id;
        if (!await showConfirmation('¿Eliminar esta cita?', { confirmText: 'Sí, eliminar' })) {
          return;
        }
        const res = await fetch(`/admin/eliminar_cita/${id}`, { method: 'POST' });
        if (res.ok) {
          location.reload();
        } else {
          alert('Error al eliminar');
        }
      });
    });

    document.getElementById('add-cita-btn').addEventListener('click', async () => {
      const usuario = document.getElementById('new-usuario').value.trim();
      const servicio = document.getElementById('new-servicio').value.trim();
      const fecha = document.getElementById('new-fecha').value;
      const hora = document.getElementById('new-hora').value;
      const mecanico = document.getElementById('new-mecanico').value;
      const estado = document.getElementById('new-estado').value;
      if (!usuario || !servicio || !fecha || !hora) return alert('Complete los campos');
      if (!await showConfirmation('¿Desea confirmar la creación de esta cita?', { confirmText: 'Sí, crear' })) return;
      const params = new URLSearchParams({ id_usuario: usuario, servicio, fecha, hora, estado, id_mecanico: mecanico });
      const res = await fetch('/admin/agregar_cita', {
        method: 'POST',
        headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
        body: params.toString()
      });
      if (res.ok) location.reload();
      else alert('Error al agregar cita');
    });

    // — Filtros de Citas —
    const filtros = {
      desde: document.getElementById('filtrar-desde'),
      hasta: document.getElementById('filtrar-hasta'),
      estado: document.getElementById('filtrar-estado'),
      mecanico: document.getElementById('filtrar-mecanico'),
      servicio: document.getElementById('filtrar-servicio'),
      busqueda: document.getElementById('filtrar-busqueda'),
    };

    function filtrarTabla() {
      const d = filtros.desde.value;
      const h = filtros.hasta.value;
      const est = filtros.estado.value.toLowerCase();
      const mec = filtros.mecanico.value;
      const serv = filtros.servicio.value.toLowerCase();
      const busc = filtros.busqueda.value.toLowerCase();
      document.querySelectorAll('#citas-table tbody tr').forEach(tr => {
        if (tr.classList.contains('new-row')) return; // fila nueva
        const fecha = tr.querySelector('input[name="fecha"]').value;
        const estado = tr.querySelector('select[name="estado"]').value.toLowerCase();
        const mecanico = tr.querySelector('select[name="id_mecanico"]').value;
        const servicio = tr.querySelector('input[name="servicio"]').value.toLowerCase();
        const usuario = tr.children[1].textContent.toLowerCase();
        const telefono = tr.children[2].textContent.toLowerCase();

        let mostrar = true;
        if (d && fecha < d) mostrar = false;
        if (h && fecha > h) mostrar = false;
        if (est && estado !== est) mostrar = false;
        if (mec && mecanico !== mec) mostrar = false;
        if (serv && !servicio.includes(serv)) mostrar = false;
        if (busc && !usuario.includes(busc) && !telefono.includes(busc)) mostrar = false;
        tr.dataset.filteredOut = mostrar ? 'false' : 'true';
      });
      citasPaginator.goToPage(1);
    }

    Object.values(filtros).forEach(el => el.addEventListener('input', filtrarTabla));
    document.getElementById('buscar-filtros').addEventListener('click', filtrarTabla);
    document.getElementById('limpiar-filtros').addEventListener('click', () => {
      Object.values(filtros).forEach(el => el.value = '');
      filtrarTabla();
    });

    filtrarTabla();

    // — CRUD Mecánicos —
    document.querySelectorAll('.edit-mecanico-btn').forEach(btn => {
      btn.addEventListener('click', () => {
        const tr = btn.closest('tr');
        tr.querySelectorAll('input').forEach(i => i.disabled = false);
        btn.style.display = 'none';
        tr.querySelector('.save-mecanico-btn').style.display = 'inline-block';
      });
    });

    document.querySelectorAll('.save-mecanico-btn').forEach(btn => {
      btn.addEventListener('click', async () => {
        const tr = btn.closest('tr');
        const id = tr.dataset.id;
        const nombre  = tr.querySelector('input[name="nombre"]').value.trim();
        const telefono = tr.querySelector('input[name="telefono"]').value.trim();

        if (!await showConfirmation('¿Desea confirmar los cambios de este mecánico?')) {
          return;
        }

        const params = new URLSearchParams({ nombre, telefono });
        const res = await fetch(`/admin/actualizar_mecanico/${id}`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
          body: params.toString()
        });
        if (res.ok) {
          tr.querySelectorAll('input').forEach(i => i.disabled = true);
          btn.style.display = 'none';
          tr.querySelector('.edit-mecanico-btn').style.display = 'inline-block';
        } else {
          alert('Error al guardar cambios');
        }
      });
    });

    document.querySelectorAll('.delete-mecanico-btn').forEach(btn => {
      btn.addEventListener('click', async () => {
        const tr = btn.closest('tr');
        const id = tr.dataset.id;
        if (!await showConfirmation('¿Eliminar este mecánico?', { confirmText: 'Sí, eliminar' })) {
          return;
        }
        const res = await fetch(`/admin/eliminar_mecanico/${id}`, { method: 'POST' });
        if (res.ok) {
          location.reload();
        } else {
          alert('Error al eliminar');
        }
      });
    });

    document.getElementById('add-mecanico-btn').addEventListener('click', async () => {
      const nombre = document.getElementById('new-nombre').value.trim();
      const telefono = document.getElementById('new-telefono').value.trim();
      if (!nombre || !telefono) return alert('Complete los campos');
      if (!await showConfirmation('¿Desea confirmar la creación de este mecánico?', { confirmText: 'Sí, crear' })) return;
      const params = new URLSearchParams({ nombre, telefono });
      const res = await fetch('/admin/agregar_mecanico', {
        method: 'POST',
        headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
        body: params.toString()
      });
      if (res.ok) location.reload();
      else alert('Error al agregar mecánico');
    });

    const addUserForm = document.getElementById('add-usuario-form');
    if (addUserForm) {
      addUserForm.addEventListener('submit', async (event) => {
        event.preventDefault();
        if (!await showConfirmation('¿Desea confirmar la creación de este usuario?', { confirmText: 'Sí, crear' })) {
          return;
        }
        const formData = new FormData(addUserForm);
        const params = new URLSearchParams();
        formData.forEach((value, key) => {
          params.append(key, value.toString());
        });
        const res = await fetch('/admin/agregar_usuario', {
          method: 'POST',
          headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
          body: params.toString()
        });
        if (res.ok) {
          location.reload();
        } else {
          let mensaje = 'Error al crear usuario';
          try {
            const data = await res.json();
            if (data.error) mensaje = data.error;
          } catch (err) {}
          alert(mensaje);
        }
      });
    }
  </script>
</body>
</html>
