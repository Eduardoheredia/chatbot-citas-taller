<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Panel de Administración</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;500;700&display=swap" rel="stylesheet">
  <style>
    body {
      font-family: 'Roboto', Arial, sans-serif;
      background-color: #f8f9fa;
      padding: 1rem;
    }
    h1 { font-weight: 700; margin-bottom: 1rem; }
    section { margin-bottom: 2rem; }
    table {
      width: 100%;
      background: #fff;
      border-collapse: collapse;
      border-radius: 0.5rem;
      overflow: hidden;
      margin-bottom: 1rem;
    }
    th, td { border: 1px solid #dee2e6; padding: 0.75rem; text-align: left; }
    thead th { background-color: #e9ecef; }
    tbody tr:nth-child(even) { background-color: #f8f9fa; }
    button i { margin-right: 0.25rem; }
    .edit-btn   { background-color: #ffc107; color: #212529; }
    .save-btn   { background-color: #28a745; color: #fff; }
    .delete-btn { background-color: #dc3545; color: #fff; }
    @media (max-width: 768px) {
      table { font-size: 0.85rem; display: block; overflow-x: auto; }
      th, td { white-space: nowrap; }
    }
    .usuarios-section thead th { background-color: #6c757d; color: #fff; }
    .citas-section thead th { background-color: #0d6efd; color: #fff; }
    .mecanicos-section thead th { background-color: #6f42c1; color: #fff; }
  </style>
</head>
<body>
  <h1>Panel de Administración</h1>
  <a href="/logout" class="btn btn-danger mb-3">Cerrar sesión</a>

  <!-- === Usuarios (solo lectura) === -->
  <section class="usuarios-section">
    <h2 class="mb-2">Usuarios</h2>
    <div class="table-responsive">
    <table id="usuarios-table" class="table table-bordered table-hover">
      <thead>
      <tr>
        <th>ID</th>
        <th>Teléfono</th>
        <th>Es admin</th>
      </tr>
      </thead>
      <tbody>
        {% for u in usuarios %}
        <tr>
          <td>{{ u.id_usuario }}</td>
          <td>{{ u.telefono }}</td>
          <td>{{ 'Sí' if u.es_admin else 'No' }}</td>
        </tr>
        {% endfor %}
      </tbody>
    </table>
    </div>
  </section>

  <!-- === Citas (edición rápida) === -->
  <section class="citas-section">
    <h2 class="mb-2">Citas</h2>
    <div class="table-responsive">
    <table id="citas-table" class="table table-bordered table-hover">
      <thead>
      <tr>
        <th>ID</th>
        <th>Usuario</th>
        <th>Teléfono</th>
        <th>Servicio</th>
        <th>Fecha</th>
        <th>Hora</th>
        <th>Mecánico</th>
        <th>Estado</th>
        <th>Acción</th>
      </tr>
    </thead>
    <tbody>
      {% for c in citas %}
      <tr data-id="{{ c.id_citas }}">
        <td>{{ c.id_citas }}</td>
        <td>{{ c.id_usuario }}</td>
        <td>{{ c.telefono }}</td>
        <td><input type="text" name="servicio" value="{{ c.servicio }}" disabled></td>
        <td><input type="date" name="fecha" value="{{ c.fecha }}" disabled></td>
        <td><input type="time" name="hora" value="{{ c.hora }}" disabled></td>
        <td>
          <select name="id_mecanico" disabled>
            <option value="">Sin asignar</option>
            {% for m in mecanicos %}
            <option value="{{ m.id_mecanico }}" {% if c.id_mecanico == m.id_mecanico %}selected{% endif %}>{{ m.nombre }}</option>
            {% endfor %}
          </select>
        </td>
        <td>
          <select name="estado" disabled>
            <option value="confirmada" {% if c.estado=='confirmada' %}selected{% endif %}>confirmada</option>
            <option value="reprogramada" {% if c.estado=='reprogramada' %}selected{% endif %}>reprogramada</option>
            <option value="cancelada" {% if c.estado=='cancelada' %}selected{% endif %}>cancelada</option>
            <option value="completada" {% if c.estado=='completada' %}selected{% endif %}>completada</option>
          </select>
        </td>
        <td>
          <button class="edit-cita-btn btn btn-sm edit-btn"><i class="fa-solid fa-pen"></i> Editar</button>
          <button class="save-cita-btn btn btn-sm save-btn" style="display:none;"><i class="fa-solid fa-floppy-disk"></i> Guardar</button>
          <button class="delete-cita-btn btn btn-sm delete-btn"><i class="fa-solid fa-trash"></i> Eliminar</button>
        </td>
      </tr>
      {% endfor %}
      <tr>
        <td>Nuevo</td>
        <td>
          <select id="new-usuario">
            <option value="" selected disabled>Seleccione teléfono</option>
            {% for u in usuarios %}
            <option value="{{ u.id_usuario }}">{{ u.telefono }}</option>
            {% endfor %}
          </select>
        </td>
        <td></td>
        <td><input type="text" id="new-servicio" placeholder="Servicio"></td>
        <td><input type="date" id="new-fecha"></td>
        <td><input type="time" id="new-hora"></td>
        <td>
          <select id="new-mecanico">
            <option value="" selected>Sin asignar</option>
            {% for m in mecanicos %}
            <option value="{{ m.id_mecanico }}">{{ m.nombre }}</option>
            {% endfor %}
          </select>
        </td>
        <td>
          <select id="new-estado">
            <option value="confirmada">confirmada</option>
            <option value="reprogramada">reprogramada</option>
            <option value="cancelada">cancelada</option>
            <option value="completada">completada</option>
          </select>
        </td>
        <td><button id="add-cita-btn" class="btn btn-sm btn-primary"><i class="fa-solid fa-plus"></i> Agregar</button></td>
      </tr>
    </tbody>
    </table>
    </div>
  </section>

  <!-- === Mecánicos (CRUD) === -->
  <section class="mecanicos-section">
    <h2 class="mb-2">Mecánicos</h2>
    <div class="table-responsive">
    <table id="mecanicos-table" class="table table-bordered table-hover">
      <thead>
      <tr>
        <th>ID</th>
        <th>Nombre</th>
        <th>Teléfono</th>
        <th>Acciones</th>
      </tr>
      </thead>
      <tbody>
        {% for m in mecanicos %}
      <tr data-id="{{ m.id_mecanico }}">
        <td>{{ m.id_mecanico }}</td>
        <td><input type="text" name="nombre" value="{{ m.nombre }}" disabled></td>
        <td><input type="tel" name="telefono" value="{{ m.telefono }}" disabled></td>
        <td>
          <button class="edit-mecanico-btn btn btn-sm edit-btn"><i class="fa-solid fa-pen"></i> Editar</button>
          <button class="save-mecanico-btn btn btn-sm save-btn" style="display:none;"><i class="fa-solid fa-floppy-disk"></i> Guardar</button>
          <button class="delete-mecanico-btn btn btn-sm delete-btn"><i class="fa-solid fa-trash"></i> Eliminar</button>
        </td>
      </tr>
      {% endfor %}
      <tr>
        <td>Nuevo</td>
        <td><input type="text" id="new-nombre" placeholder="Nombre"></td>
        <td><input type="tel" id="new-telefono" placeholder="Teléfono"></td>
        <td><button id="add-mecanico-btn" class="btn btn-sm btn-primary"><i class="fa-solid fa-plus"></i> Agregar</button></td>
      </tr>
    </tbody>
    </table>
    </div>
  </section>

  <script>
    // — CRUD Citas —
    document.querySelectorAll('.edit-cita-btn').forEach(btn => {
      btn.addEventListener('click', () => {
        const tr = btn.closest('tr');
        tr.querySelectorAll('input, select').forEach(i => i.disabled = false);
        btn.style.display = 'none';
        tr.querySelector('.save-cita-btn').style.display = 'inline-block';
      });
    });

    document.querySelectorAll('.save-cita-btn').forEach(btn => {
      btn.addEventListener('click', async () => {
        const tr = btn.closest('tr');
        const id = tr.dataset.id;
        const servicio = tr.querySelector('input[name="servicio"]').value;
        const fecha = tr.querySelector('input[name="fecha"]').value;
        const hora   = tr.querySelector('input[name="hora"]').value;
        const mecanico = tr.querySelector('select[name="id_mecanico"]').value;
        const estado = tr.querySelector('select[name="estado"]').value;
        const params = new URLSearchParams({ servicio, fecha, hora, estado, id_mecanico: mecanico });
        const res = await fetch(`/admin/actualizar_cita/${id}`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
          body: params.toString()
        });
        if (res.ok) {
          tr.querySelectorAll('input, select').forEach(i => i.disabled = true);
          btn.style.display = 'none';
          tr.querySelector('.edit-cita-btn').style.display = 'inline-block';
        } else {
          alert('Error al actualizar la cita');
        }
      });
    });

    document.querySelectorAll('.delete-cita-btn').forEach(btn => {
      btn.addEventListener('click', () => {
        const tr = btn.closest('tr');
        const id = tr.dataset.id;
        if (confirm('¿Eliminar esta cita?')) {
          fetch(`/admin/eliminar_cita/${id}`, { method: 'POST' })
            .then(res => res.ok ? location.reload() : alert('Error al eliminar'));
        }
      });
    });

    document.getElementById('add-cita-btn').addEventListener('click', async () => {
      const usuario = document.getElementById('new-usuario').value.trim();
      const servicio = document.getElementById('new-servicio').value.trim();
      const fecha = document.getElementById('new-fecha').value;
      const hora = document.getElementById('new-hora').value;
      const mecanico = document.getElementById('new-mecanico').value;
      const estado = document.getElementById('new-estado').value;
      if (!usuario || !servicio || !fecha || !hora) return alert('Complete los campos');
      const params = new URLSearchParams({ id_usuario: usuario, servicio, fecha, hora, estado, id_mecanico: mecanico });
      const res = await fetch('/admin/agregar_cita', {
        method: 'POST',
        headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
        body: params.toString()
      });
      if (res.ok) location.reload();
      else alert('Error al agregar cita');
    });

    // — CRUD Mecánicos —
    document.querySelectorAll('.edit-mecanico-btn').forEach(btn => {
      btn.addEventListener('click', () => {
        const tr = btn.closest('tr');
        tr.querySelectorAll('input').forEach(i => i.disabled = false);
        btn.style.display = 'none';
        tr.querySelector('.save-mecanico-btn').style.display = 'inline-block';
      });
    });

    document.querySelectorAll('.save-mecanico-btn').forEach(btn => {
      btn.addEventListener('click', async () => {
        const tr = btn.closest('tr');
        const id = tr.dataset.id;
        const nombre  = tr.querySelector('input[name="nombre"]').value.trim();
        const telefono = tr.querySelector('input[name="telefono"]').value.trim();
        const params = new URLSearchParams({ nombre, telefono });
        const res = await fetch(`/admin/actualizar_mecanico/${id}`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
          body: params.toString()
        });
        if (res.ok) {
          tr.querySelectorAll('input').forEach(i => i.disabled = true);
          btn.style.display = 'none';
          tr.querySelector('.edit-mecanico-btn').style.display = 'inline-block';
        } else {
          alert('Error al guardar cambios');
        }
      });
    });

    document.querySelectorAll('.delete-mecanico-btn').forEach(btn => {
      btn.addEventListener('click', () => {
        const tr = btn.closest('tr');
        const id = tr.dataset.id;
        if (confirm('¿Eliminar este mecánico?')) {
          fetch(`/admin/eliminar_mecanico/${id}`, { method: 'POST' })
            .then(res => res.ok ? location.reload() : alert('Error al eliminar'));
        }
      });
    });

    document.getElementById('add-mecanico-btn').addEventListener('click', async () => {
      const nombre = document.getElementById('new-nombre').value.trim();
      const telefono = document.getElementById('new-telefono').value.trim();
      if (!nombre || !telefono) return alert('Complete los campos');
      const params = new URLSearchParams({ nombre, telefono });
      const res = await fetch('/admin/agregar_mecanico', {
        method: 'POST',
        headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
        body: params.toString()
      });
      if (res.ok) location.reload();
      else alert('Error al agregar mecánico');
    });
  </script>
</body>
</html>