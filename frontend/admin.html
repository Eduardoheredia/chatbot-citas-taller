<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<title>Panel de Administración</title>
<style>
  body {font-family: Arial, sans-serif; padding: 1rem;}
  table {border-collapse: collapse; width: 100%; margin-bottom: 2rem;}
  th, td {border: 1px solid #ccc; padding: 0.75rem; text-align: left;}
  th {background-color: #f0f0f0;}
  button {
    padding: 0.4rem 0.8rem;
    border: none;
    border-radius: 4px;
    cursor: pointer;
    background-color: #3498db;
    color: #fff;
  }
  button.delete-btn {background-color: #e74c3c;}
  button.edit-btn.save {background-color: #2ecc71;}
  @media (max-width: 600px) {
    table {font-size: 0.9rem;}
    th, td {padding: 0.5rem;}
  }
</style>
</head>
<body>
  <h1>Panel de Administración</h1>
  <a href="/logout">Cerrar sesión</a>

  <h2>Usuarios</h2>
  <table>
    <tr><th>ID</th><th>Teléfono</th><th>Es admin</th></tr>
    {% for u in usuarios %}
    <tr>
      <td>{{ u['id_usuario'] }}</td>
      <td>{{ u['telefono'] }}</td>
      <td>{{ u['es_admin'] }}</td>
    </tr>
    {% endfor %}
  </table>

  <h2>Citas</h2>
  <table>
    <tr>
      <th>ID</th>
      <th>Usuario</th>
      <th>Servicio</th>
      <th>Fecha</th>
      <th>Hora</th>
      <th>Estado</th>
      <th></th>
    </tr>
    {% for c in citas %}
    <form action="/admin/actualizar_cita/{{ c['id_citas'] }}" method="post" style="display: contents;">
      <tr>
        <td>{{ c['id_citas'] }}</td>
        <td>{{ c['id_usuario'] }}</td>
        <td><input name="servicio" value="{{ c['servicio'] }}"></td>
        <td><input type="date" name="fecha" value="{{ c['fecha'] }}"></td>
        <td><input type="time" name="hora" value="{{ c['hora'] }}"></td>
        <td>
          <select name="estado">
            <option value="confirmada" {% if c['estado']=='confirmada' %}selected{% endif %}>confirmada</option>
            <option value="reprogramada" {% if c['estado']=='reprogramada' %}selected{% endif %}>reprogramada</option>
            <option value="cancelada" {% if c['estado']=='cancelada' %}selected{% endif %}>cancelada</option>
            <option value="completada" {% if c['estado']=='completada' %}selected{% endif %}>completada</option>
          </select>
        </td>
        <td><button type="submit">Guardar</button></td>
      </tr>
    </form>
    {% endfor %}
  </table>

  <h2>Mecánicos</h2>
  <table>
    <tr>
      <th>ID</th>
      <th>Nombre</th>
      <th>Teléfono</th>
      <th></th>
      <th></th>
    </tr>
    {% for m in mecanicos %}
    <tr>
      <form data-id="{{ m['id_mecanico'] }}" class="mecanico-form" action="/admin/actualizar_mecanico/{{ m['id_mecanico'] }}" method="post" style="display: contents;">
        <td>{{ m['id_mecanico'] }}</td>
        <td><input name="nombre" value="{{ m['nombre'] }}" disabled></td>
        <td><input name="telefono" value="{{ m['telefono'] }}" disabled></td>
        <td><button type="button" class="edit-btn">Editar</button></td>
      </form>
      <td>
        <form action="/admin/eliminar_mecanico/{{ m['id_mecanico'] }}" method="post" style="display: inline;">
          <button type="submit" class="delete-btn">Eliminar</button>
        </form>
      </td>
    </tr>
    {% endfor %}
    <tr>
      <form action="/admin/agregar_mecanico" method="post" style="display: contents;">
        <td>Nuevo</td>
        <td><input name="nombre" placeholder="Nombre"></td>
        <td><input name="telefono" placeholder="Teléfono"></td>
        <td colspan="2"><button type="submit">Agregar</button></td>
      </form>
    </tr>
  </table>
  <script>
    document.querySelectorAll('.mecanico-form .edit-btn').forEach(btn => {
      btn.addEventListener('click', async () => {
        const form = btn.closest('.mecanico-form');
        const inputs = form.querySelectorAll('input');
        const editing = btn.getAttribute('data-editing') === 'true';
        if (!editing) {
          inputs.forEach(i => i.disabled = false);
          btn.setAttribute('data-editing', 'true');
          btn.textContent = 'Guardar';
          btn.classList.add('save');
        } else {
          const params = new URLSearchParams();
          inputs.forEach(i => params.append(i.name, i.value));
          const id = form.dataset.id;
          const res = await fetch(`/admin/actualizar_mecanico/${id}`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
            body: params.toString()
          });
          if (res.ok) {
            inputs.forEach(i => i.disabled = true);
            btn.setAttribute('data-editing', 'false');
            btn.textContent = 'Editar';
            btn.classList.remove('save');
          } else {
            alert('Error al guardar');
          }
        }
      });
    });
  </script>
</body>
</html>