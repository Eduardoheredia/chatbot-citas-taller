<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <title>Panel de Administración</title>
    <style>
      body { font-family: Arial; padding: 2rem; background:#f2f2f2; }
      table { border-collapse: collapse; width: 100%; margin-bottom:2rem; }
      th, td { border: 1px solid #ccc; padding: 0.5rem; text-align:left; }
      th { background: #eee; }
      h2 { margin-top:2rem; }
    </style>
</head>
<body>
    <h1>Panel de Administración</h1>

    <h2>Usuarios</h2>
    <table>
        <tr>
            <th>ID</th>
            <th>Teléfono</th>
            <th>Es admin</th>
        </tr>
        {% for u in usuarios %}
        <tr>
            <td>{{ u[0] }}</td>
            <td>{{ u[1] }}</td>
            <td>{{ 'Sí' if u[2] else 'No' }}</td>
        </tr>
        {% endfor %}
    </table>

    <h2>Citas</h2>
    <form method="get" action="/admin">
        <input type="text" name="servicio" placeholder="Servicio" value="{{ filtros.servicio }}" />
        <input type="date" name="fecha" value="{{ filtros.fecha }}" />
        <input type="time" name="hora" value="{{ filtros.hora }}" />
        <button type="submit">Filtrar</button>
        <a href="/admin/export_csv">Exportar CSV</a>
    </form>
    <table>
        <tr>
            <th>ID Cita</th>
            <th>ID Usuario</th>
            <th>Servicio</th>
            <th>Fecha</th>
            <th>Hora</th>
            <th>Estado</th>
            <th>Acciones</th>
        </tr>
        {% for c in citas %}
        <tr>
            <form method="post" action="/admin/update_cita">
                <td>{{ c[0] }}<input type="hidden" name="id_citas" value="{{ c[0] }}" /></td>
                <td>{{ c[1] }}</td>
                <td>{{ c[2] }}</td>
                <td><input type="date" name="fecha" value="{{ c[3] }}" /></td>
                <td><input type="time" name="hora" value="{{ c[4] }}" /></td>
                <td>
                    <select name="estado">
                        {% for est in ['confirmada','reprogramada','cancelada','completada'] %}
                        <option value="{{ est }}" {% if c[5]==est %}selected{% endif %}>{{ est }}</option>
                        {% endfor %}
                    </select>
                </td>
                <td>
                    <button type="submit">Guardar</button>
            </form>
            <form method="post" action="/admin/delete_cita" style="display:inline" onsubmit="return confirm('¿Eliminar cita?');">
                <input type="hidden" name="id_citas" value="{{ c[0] }}" />
                <button type="submit">Eliminar</button>
            </form>
                </td>
        </tr>
        {% endfor %}
    </table>

    <h2>Mecánicos</h2>
    <form method="post" action="/admin/add_mecanico">
        <input type="text" name="nombre" placeholder="Nombre" required />
        <input type="text" name="especialidad" placeholder="Especialidad" />
        <button type="submit">Agregar</button>
    </form>
    <table>
        <tr>
            <th>ID</th>
            <th>Nombre</th>
            <th>Especialidad</th>
            <th>Acciones</th>
        </tr>
        {% for m in mecanicos %}
        <tr>
            <form method="post" action="/admin/update_mecanico">
                <td>{{ m[0] }}<input type="hidden" name="id" value="{{ m[0] }}" /></td>
                <td><input type="text" name="nombre" value="{{ m[1] }}" /></td>
                <td><input type="text" name="especialidad" value="{{ m[2] or '' }}" /></td>
                <td>
                    <button type="submit">Guardar</button>
            </form>
            <form method="post" action="/admin/delete_mecanico" style="display:inline" onsubmit="return confirm('¿Eliminar mecánico?');">
                <input type="hidden" name="id" value="{{ m[0] }}" />
                <button type="submit">Eliminar</button>
            </form>
                </td>
        </tr>
        {% endfor %}
    </table>

    <h2>Asignación de Mecánicos</h2>
    <form method="post" action="/admin/asignar_servicios">
        <select name="servicio_id">
            {% for s in servicios %}
            <option value="{{ s[0] }}">{{ s[1] }}</option>
            {% endfor %}
        </select>
        <div>
            {% for m in mecanicos %}
            <label>
                <input type="checkbox" name="mecanicos" value="{{ m[0] }}" /> {{ m[1] }}
            </label>
            {% endfor %}
        </div>
        <button type="submit">Guardar</button>
    </form>

    <h3>Asignaciones actuales</h3>
    <table>
        <tr><th>Servicio</th><th>Mecánico</th></tr>
        {% for sid, mid in asignaciones %}
        <tr>
            <td>{{ servicios|selectattr('0', 'equalto', sid)|map(attribute=1)|list|first }}</td>
            <td>{{ mecanicos|selectattr('0', 'equalto', mid)|map(attribute=1)|list|first }}</td>
        </tr>
        {% endfor %}
    </table>
</body>
</html>